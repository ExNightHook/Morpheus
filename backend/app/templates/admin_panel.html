<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morpheus Admin - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 24px; }
        .header button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .header button:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }
        .card h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        button.btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        button.btn:hover {
            transform: translateY(-2px);
        }
        button.btn-danger {
            background: #e74c3c;
        }
        button.btn-success {
            background: #27ae60;
        }
        button.btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            margin-top: 0;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .price-item span {
            font-weight: 500;
        }
        .build-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Morpheus Admin Panel</h1>
        <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
    <div class="container">
        <div id="alert" class="alert"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</button>
            <button class="tab" onclick="showTab('products')">üì¶ –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="tab" onclick="showTab('keys')">üîë –ö–ª—é—á–∏</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="tab" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h3>
                    <div class="value" id="stat-products">-</div>
                </div>
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –∫–ª—é—á–µ–π</h3>
                    <div class="value" id="stat-keys">-</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π</h3>
                    <div class="value" id="stat-active-keys">-</div>
                </div>
                <div class="stat-card">
                    <h3>–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</h3>
                    <div class="value" id="stat-bot-status">-</div>
                </div>
            </div>
            <div class="card">
                <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    <button class="btn" onclick="showTab('products')">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
                    <button class="btn" onclick="showTab('keys')">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                    <button class="btn" onclick="showTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</button>
                </div>
            </div>
        </div>

        <!-- Products -->
        <div id="products" class="tab-content">
            <div class="card">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h2>
                <form id="productForm" onsubmit="createProduct(event)">
                    <div class="form-group">
                        <label>Slug (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ API)</label>
                        <input type="text" id="product-slug" required placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Stalcraft chams (–ø—Ä–æ–±–µ–ª—ã –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –¥–µ—Ñ–∏—Å—ã)">
                    </div>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="product-title" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="product-description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
                </form>
            </div>
            
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
                <div id="products-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- Keys -->
        <div id="keys" class="tab-content">
            <div class="card">
                <h2>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</h2>
                <form id="keysForm" onsubmit="generateKeys(event)">
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>–ü—Ä–æ–¥—É–∫—Ç</label>
                            <select id="key-product" required></select>
                        </div>
                        <div class="form-group">
                            <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                            <input type="number" id="key-duration" required min="1" value="30">
                        </div>
                        <div class="form-group">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" id="key-count" required min="1" max="1000" value="10">
                        </div>
                    </div>
                    <button type="submit" class="btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                </form>
            </div>
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π</h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É</label>
                    <select id="keys-filter-product" onchange="loadKeys()">
                        <option value="">–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>
                    </select>
                </div>
                <div id="keys-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h2>
                <form id="settingsForm" onsubmit="updateSettings(event)">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <span>–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω</span>
                            <label class="switch">
                                <input type="checkbox" id="bot-enabled">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <span>–†–µ–∂–∏–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç</span>
                            <label class="switch">
                                <input type="checkbox" id="maintenance-mode">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                        <textarea id="alert-message" rows="3" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
                    </div>
                    <div class="form-group">
                        <label>–°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–∞—Ö</label>
                        <textarea id="technical-message" rows="3" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
                    </div>
                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </form>
            </div>
        </div>

        <!-- Users -->
        <div id="users" class="tab-content">
            <div class="card">
                <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                <div id="users-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–º -->
    <div id="productModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 id="modal-title" style="margin-bottom: 20px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–º</h2>
            <div id="modal-content"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeProductModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let adminToken = localStorage.getItem('admin_token');
        
        if (!adminToken) {
            window.location.href = '/admin/login';
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type} show`;
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Authorization': `Bearer ${adminToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            // –£–±–∏—Ä–∞–µ–º Content-Type –¥–ª—è form-data
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });
            
            if (response.status === 401) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
                return null;
            }
            
            return response;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'products') loadProducts();
            if (tabName === 'keys') {
                loadProductsForKeys();
                loadKeys();
            }
            if (tabName === 'settings') loadSettings();
            if (tabName === 'users') loadUsers();
        }

        async function loadDashboard() {
            try {
                const [products, keys, settings] = await Promise.all([
                    apiCall('/admin/products').then(r => r.json()),
                    apiCall('/admin/keys').then(r => r.json()),
                    apiCall('/admin/settings').then(r => r.json())
                ]);
                
                document.getElementById('stat-products').textContent = products.length;
                document.getElementById('stat-keys').textContent = keys.length;
                document.getElementById('stat-active-keys').textContent = keys.filter(k => k.status === 'available').length;
                document.getElementById('stat-bot-status').textContent = settings.bot_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω';
            } catch (e) {
                console.error(e);
            }
        }

        async function loadProducts() {
            try {
                const response = await apiCall('/admin/products');
                const products = await response.json();
                const listDiv = document.getElementById('products-list');
                
                if (products.length === 0) {
                    listDiv.innerHTML = '<p>–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>';
                    return;
                }
                
                listDiv.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Slug</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td><code>${p.slug}</code></td>
                                    <td>${p.title}</td>
                                    <td>${p.description || '-'}</td>
                                    <td>${p.is_active ? '<span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>' : '<span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>'}</td>
                                    <td>
                                        <div class="actions">
                                            <button class="btn btn-small" onclick="manageProduct(${p.id})">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                                            <button class="btn btn-small btn-edit-product" 
                                                    data-product-id="${p.id}" 
                                                    data-product-title="${(p.title || '').replace(/"/g, '&quot;')}" 
                                                    data-product-description="${(p.description || '').replace(/"/g, '&quot;').replace(/\n/g, '\\n')}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                            <button class="btn btn-small btn-danger btn-delete-product" 
                                                    data-product-id="${p.id}" 
                                                    data-product-title="${(p.title || '').replace(/"/g, '&quot;')}">–£–¥–∞–ª–∏—Ç—å</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                document.getElementById('products-list').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function manageProduct(productId) {
            try {
                const [product, prices, builds] = await Promise.all([
                    apiCall(`/admin/products`).then(r => r.json()).then(ps => ps.find(p => p.id === productId)),
                    apiCall(`/admin/products/${productId}/prices`).then(r => r.json()).catch(() => []),
                    apiCall(`/admin/builds/${productId}`).then(r => r.json()).catch(() => [])
                ]);
                
                const modal = document.getElementById('productModal');
                const modalTitle = document.getElementById('modal-title');
                const modalContent = document.getElementById('modal-content');
                
                modalTitle.textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${product.title}`;
                modalContent.innerHTML = `
                    <div>
                        <h3>–¶–µ–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–∞</h3>
                        <div id="prices-list-${productId}">
                            ${prices.length > 0 ? prices.map(p => `
                                <div class="price-item">
                                    <span>${p.duration_days} –¥–Ω–µ–π - ${p.price_rub}‚ÇΩ</span>
                                    <div class="actions">
                                        <button class="btn btn-small" onclick="editPrice(${productId}, ${p.id}, ${p.duration_days}, ${p.price_rub})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                        <button class="btn btn-small btn-danger" onclick="deletePrice(${productId}, ${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                            `).join('') : '<p>–ù–µ—Ç —Ü–µ–Ω</p>'}
                        </div>
                        <form onsubmit="addPrice(event, ${productId})">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                                    <input type="number" id="price-duration-${productId}" required min="1" placeholder="1, 7, 14, 30, 90">
                                </div>
                                <div class="form-group">
                                    <label>–¶–µ–Ω–∞ (—Ä—É–±–ª–µ–π)</label>
                                    <input type="number" id="price-amount-${productId}" required min="0" step="0.01">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-small">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É</button>
                        </form>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>–ë–∏–ª–¥—ã –ø—Ä–æ–¥—É–∫—Ç–∞</h3>
                        <div id="builds-list-${productId}">
                            ${builds.length > 0 ? builds.map(b => `
                                <div class="build-item">
                                    <span>${b.label} - ${b.file_path}</span>
                                    <span class="badge ${b.is_active ? 'badge-success' : 'badge-danger'}">${b.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
                                </div>
                            `).join('') : '<p>–ù–µ—Ç –±–∏–ª–¥–æ–≤</p>'}
                        </div>
                        <form onsubmit="uploadBuild(event, ${productId})" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–ª–¥–∞</label>
                                <input type="text" id="build-label-${productId}" required placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: v1.0.0">
                            </div>
                            <div class="form-group">
                                <label>ZIP —Ñ–∞–π–ª</label>
                                <input type="file" id="build-file-${productId}" required accept=".zip">
                            </div>
                            <button type="submit" class="btn btn-small">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–ª–¥</button>
                        </form>
                    </div>
                `;
                
                modal.style.display = 'flex';
            } catch (e) {
                console.error(e);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function addPrice(e, productId) {
            e.preventDefault();
            const data = {
                duration_days: parseInt(document.getElementById(`price-duration-${productId}`).value),
                price_rub: parseFloat(document.getElementById(`price-amount-${productId}`).value)
            };
            
            try {
                const response = await apiCall(`/admin/products/${productId}/prices`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–¶–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    manageProduct(productId);
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã', 'error');
            }
        }

        async function editPrice(productId, priceId, currentDuration, currentPrice) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            modalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã`;
            modalContent.innerHTML = `
                <form onsubmit="savePrice(event, ${productId}, ${priceId})">
                    <div class="form-row">
                        <div class="form-group">
                            <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                            <input type="number" id="edit-price-duration-${priceId}" value="${currentDuration}" required min="1">
                        </div>
                        <div class="form-group">
                            <label>–¶–µ–Ω–∞ (—Ä—É–±–ª–µ–π)</label>
                            <input type="number" id="edit-price-amount-${priceId}" value="${currentPrice}" required min="0" step="0.01">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-danger" onclick="closeProductModal(); manageProduct(${productId})">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            `;
            
            modal.style.display = 'flex';
        }

        async function savePrice(e, productId, priceId) {
            e.preventDefault();
            const data = {
                duration_days: parseInt(document.getElementById(`edit-price-duration-${priceId}`).value),
                price_rub: parseFloat(document.getElementById(`edit-price-amount-${priceId}`).value)
            };
            
            try {
                const response = await apiCall(`/admin/products/${productId}/prices/${priceId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    closeProductModal();
                    manageProduct(productId);
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã', 'error');
            }
        }

        async function deletePrice(productId, priceId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–Ω—É?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/admin/products/${productId}/prices/${priceId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('–¶–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    manageProduct(productId);
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ü–µ–Ω—ã', 'error');
            }
        }

        async function uploadBuild(e, productId) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('file', document.getElementById(`build-file-${productId}`).files[0]);
            const label = document.getElementById(`build-label-${productId}`).value;
            
            try {
                const response = await apiCall(`/admin/builds/${productId}?label=${encodeURIComponent(label)}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('–ë–∏–ª–¥ –∑–∞–≥—Ä—É–∂–µ–Ω! –°—Ç–∞—Ä—ã–µ –±–∏–ª–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã.');
                    document.getElementById(`build-file-${productId}`).value = '';
                    document.getElementById(`build-label-${productId}`).value = '';
                    manageProduct(productId);
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–ª–¥–∞', 'error');
            }
        }

        async function createProduct(e) {
            e.preventDefault();
            const data = {
                slug: document.getElementById('product-slug').value,
                title: document.getElementById('product-title').value,
                description: document.getElementById('product-description').value || null
            };
            
            try {
                const response = await apiCall('/admin/products', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–ü—Ä–æ–¥—É–∫—Ç —Å–æ–∑–¥–∞–Ω!');
                    document.getElementById('productForm').reset();
                    loadProducts();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
            }
        }

        async function editProduct(productId, currentTitle, currentDescription) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML entities
            const title = currentTitle.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            const description = (currentDescription || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/\\n/g, '\n');
            
            modalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞`;
            const formHtml = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
                    <form id="edit-product-form-${productId}">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                            <input type="text" id="edit-product-title-${productId}" value="${title.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" required>
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="edit-product-description-${productId}" rows="4">${description.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}</textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-danger" onclick="closeProductModal(); loadProducts()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            `;
            modalContent.innerHTML = formHtml;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –≤ DOM
            setTimeout(() => {
                const form = document.getElementById(`edit-product-form-${productId}`);
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveProduct(e, productId);
                    });
                }
            }, 100);
            
            modal.style.display = 'flex';
        }

        async function saveProduct(e, productId) {
            e.preventDefault();
            const data = {
                title: document.getElementById(`edit-product-title-${productId}`).value,
                description: document.getElementById(`edit-product-description-${productId}`).value || null
            };
            
            try {
                const response = await apiCall(`/admin/products/${productId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    closeProductModal();
                    loadProducts();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
            }
        }

        async function deleteProduct(productId, productTitle) {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML entities
            const title = (productTitle || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç "${title}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n- –í—Å–µ —Ü–µ–Ω—ã\n- –í—Å–µ –±–∏–ª–¥—ã –∏ –∏—Ö —Ñ–∞–π–ª—ã\n- –í—Å–µ –∫–ª—é—á–∏\n\n–ü—Ä–æ–¥—É–∫—Ç –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã.`)) {
                return;
            }
            
            try {
                const response = await apiCall(`/admin/products/${productId}`, {
                    method: 'DELETE'
                });
                
                if (!response) {
                    showAlert('–û—à–∏–±–∫–∞: –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                    return;
                }
                
                if (response.ok) {
                    try {
                        const result = await response.json();
                        showAlert('–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω!');
                        loadProducts();
                        loadDashboard();
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π, –Ω–æ –Ω–µ JSON - –≤—Å–µ —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
                        showAlert('–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω!');
                        loadProducts();
                        loadDashboard();
                    }
                } else {
                    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç
                        try {
                            const text = await response.text();
                            errorMessage = text || errorMessage;
                        } catch (textError) {
                            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        }
                    }
                    showAlert('–û—à–∏–±–∫–∞: ' + errorMessage, 'error');
                }
            } catch (e) {
                console.error('Delete error:', e);
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }

        async function loadProductsForKeys() {
            try {
                const response = await apiCall('/admin/products');
                const products = await response.json();
                const select = document.getElementById('key-product');
                const filterSelect = document.getElementById('keys-filter-product');
                
                const options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>' +
                    products.map(p => `<option value="${p.id}">${p.title} (${p.slug})</option>`).join('');
                
                select.innerHTML = options;
                filterSelect.innerHTML = '<option value="">–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>' +
                    products.map(p => `<option value="${p.id}">${p.title} (${p.slug})</option>`).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function generateKeys(e) {
            e.preventDefault();
            const data = {
                product_id: parseInt(document.getElementById('key-product').value),
                duration_days: parseInt(document.getElementById('key-duration').value),
                count: parseInt(document.getElementById('key-count').value)
            };
            
            try {
                const response = await apiCall('/admin/keys/generate', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const keys = await response.json();
                    showAlert(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${keys.length} –∫–ª—é—á–µ–π!`);
                    document.getElementById('keysForm').reset();
                    loadKeys();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π', 'error');
            }
        }

        async function loadKeys() {
            try {
                const productId = document.getElementById('keys-filter-product').value;
                const url = productId ? `/admin/keys?product_id=${productId}` : '/admin/keys';
                const response = await apiCall(url);
                const keys = await response.json();
                const listDiv = document.getElementById('keys-list');
                
                if (keys.length === 0) {
                    listDiv.innerHTML = '<p>–ù–µ—Ç –∫–ª—é—á–µ–π</p>';
                    return;
                }
                
                listDiv.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>–ö–ª—é—á</th>
                                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>UUID</th>
                                <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${keys.slice(0, 100).map(k => `
                                <tr>
                                    <td><code>${k.value}</code></td>
                                    <td>${k.duration_days} –¥–Ω.</td>
                                    <td>
                                        ${k.status === 'available' ? '<span class="badge badge-success">–î–æ—Å—Ç—É–ø–µ–Ω</span>' : ''}
                                        ${k.status === 'sold' ? '<span class="badge badge-warning">–ü—Ä–æ–¥–∞–Ω</span>' : ''}
                                        ${k.status === 'activated' ? '<span class="badge badge-success">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</span>' : ''}
                                    </td>
                                    <td>${k.activation_uuid || '-'}</td>
                                    <td>${k.expires_at ? new Date(k.expires_at).toLocaleString('ru-RU') : '-'}</td>
                                    <td>${new Date(k.created_at).toLocaleDateString('ru-RU')}</td>
                                    <td>
                                        <button class="btn btn-small" onclick="editKey(${k.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteKey(${k.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${keys.length > 100 ? '<p style="margin-top: 10px; color: #666;">–ü–æ–∫–∞–∑–∞–Ω–æ 100 –∏–∑ ' + keys.length + ' –∫–ª—é—á–µ–π</p>' : ''}
                `;
            } catch (e) {
                document.getElementById('keys-list').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function editKey(keyId) {
            try {
                const response = await apiCall('/admin/keys');
                const keys = await response.json();
                const key = keys.find(k => k.id === keyId);
                
                if (!key) {
                    showAlert('–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }
                
                const modal = document.getElementById('productModal');
                const modalTitle = document.getElementById('modal-title');
                const modalContent = document.getElementById('modal-content');
                
                modalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞: ${key.value}`;
                modalContent.innerHTML = `
                    <form onsubmit="saveKey(event, ${key.id})">
                        <div class="form-group">
                            <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                            <input type="number" id="edit-duration-${key.id}" value="${key.duration_days}" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ç—É—Å</label>
                            <select id="edit-status-${key.id}">
                                <option value="available" ${key.status === 'available' ? 'selected' : ''}>–î–æ—Å—Ç—É–ø–µ–Ω</option>
                                <option value="sold" ${key.status === 'sold' ? 'selected' : ''}>–ü—Ä–æ–¥–∞–Ω</option>
                                <option value="activated" ${key.status === 'activated' ? 'selected' : ''}>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</option>
                                <option value="expired" ${key.status === 'expired' ? 'selected' : ''}>–ò—Å—Ç–µ–∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>UUID –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</label>
                            <input type="text" id="edit-uuid-${key.id}" value="${key.activation_uuid || ''}" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å">
                        </div>
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="datetime-local" id="edit-expires-${key.id}" value="${key.expires_at ? new Date(key.expires_at).toISOString().slice(0, 16) : ''}">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-danger" onclick="closeProductModal()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                `;
                
                modal.style.display = 'flex';
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–∞', 'error');
            }
        }

        async function saveKey(e, keyId) {
            e.preventDefault();
            const data = {
                duration_days: parseInt(document.getElementById(`edit-duration-${keyId}`).value),
                status: document.getElementById(`edit-status-${keyId}`).value,
                activation_uuid: document.getElementById(`edit-uuid-${keyId}`).value || null,
            };
            
            const expiresValue = document.getElementById(`edit-expires-${keyId}`).value;
            if (expiresValue) {
                data.expires_at = new Date(expiresValue).toISOString();
            } else {
                data.expires_at = null;
            }
            
            try {
                const response = await apiCall(`/admin/keys/${keyId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–ö–ª—é—á –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    closeProductModal();
                    loadKeys();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–∞', 'error');
            }
        }

        async function deleteKey(keyId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/admin/keys/${keyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('–ö–ª—é—á —É–¥–∞–ª–µ–Ω!');
                    loadKeys();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞', 'error');
            }
        }

        async function loadSettings() {
            try {
                const response = await apiCall('/admin/settings');
                const settings = await response.json();
                
                document.getElementById('bot-enabled').checked = settings.bot_enabled;
                document.getElementById('maintenance-mode').checked = settings.maintenance_mode;
                document.getElementById('alert-message').value = settings.alert_message || '';
                document.getElementById('technical-message').value = settings.technical_message || '';
            } catch (e) {
                console.error(e);
            }
        }

        async function updateSettings(e) {
            e.preventDefault();
            const data = {
                bot_enabled: document.getElementById('bot-enabled').checked,
                maintenance_mode: document.getElementById('maintenance-mode').checked,
                alert_message: document.getElementById('alert-message').value || null,
                technical_message: document.getElementById('technical-message').value || null
            };
            
            try {
                const response = await apiCall('/admin/settings', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        async function loadUsers() {
            try {
                const response = await apiCall('/admin/users');
                const users = await response.json();
                const listDiv = document.getElementById('users-list');
                
                if (users.length === 0) {
                    listDiv.innerHTML = '<p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
                    return;
                }
                
                listDiv.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>–ê–¥–º–∏–Ω</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr>
                                    <td>${u.id}</td>
                                    <td>${u.telegram_id}</td>
                                    <td>${u.username || '-'}</td>
                                    <td>${u.is_admin ? '<span class="badge badge-success">–î–∞</span>' : '<span class="badge">–ù–µ—Ç</span>'}</td>
                                    <td>${new Date(u.created_at).toLocaleDateString('ru-RU')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                document.getElementById('users-list').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin/login';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });

        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        document.addEventListener('click', function(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
            const editBtn = e.target.closest('.btn-edit-product');
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                const productId = parseInt(editBtn.getAttribute('data-product-id'));
                const productTitle = editBtn.getAttribute('data-product-title') || '';
                const productDescription = editBtn.getAttribute('data-product-description') || '';
                editProduct(productId, productTitle, productDescription);
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
            const deleteBtn = e.target.closest('.btn-delete-product');
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                const productId = parseInt(deleteBtn.getAttribute('data-product-id'));
                const productTitle = deleteBtn.getAttribute('data-product-title') || '';
                deleteProduct(productId, productTitle);
                return;
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—à–±–æ—Ä–¥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadDashboard();
    </script>
</body>
</html>
